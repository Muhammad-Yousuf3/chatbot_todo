openapi: 3.1.0
info:
  title: Conversation Persistence API
  description: |
    Stateless chat API for AI-powered Todo Application.
    Enables conversation creation, message persistence, and history retrieval.
  version: 1.0.0
  contact:
    name: AI Todo Team

servers:
  - url: /api
    description: API base path

paths:
  /chat:
    post:
      operationId: sendMessage
      summary: Send a chat message
      description: |
        Send a message to a conversation. If conversation_id is omitted,
        creates a new conversation. Loads history, persists message, and
        returns updated conversation state.
      tags:
        - Chat
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
            examples:
              newConversation:
                summary: Start new conversation
                value:
                  content: "Hello, I need help with my tasks"
              existingConversation:
                summary: Continue existing conversation
                value:
                  conversation_id: "123e4567-e89b-12d3-a456-426614174000"
                  content: "Add a task to buy groceries"
      responses:
        '200':
          description: Message sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendMessageResponse'
        '400':
          description: Invalid request (malformed conversation_id)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: INVALID_ID_FORMAT
                  message: "Conversation ID must be a valid UUID"
        '403':
          description: Access denied (not conversation owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: ACCESS_DENIED
                  message: "You do not have access to this conversation"
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: CONVERSATION_NOT_FOUND
                  message: "Conversation does not exist"
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: VALIDATION_ERROR
                  message: "Message content cannot be empty"

  /conversations:
    get:
      operationId: listConversations
      summary: List user conversations
      description: |
        Retrieve all conversations belonging to the authenticated user,
        ordered by most recent activity first.
      tags:
        - Conversations
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Maximum number of conversations to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of conversations to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of conversations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationListResponse'

  /conversations/{conversation_id}:
    get:
      operationId: getConversation
      summary: Get conversation with messages
      description: |
        Retrieve a specific conversation including all messages
        in chronological order.
      tags:
        - Conversations
      security:
        - BearerAuth: []
      parameters:
        - name: conversation_id
          in: path
          required: true
          description: UUID of the conversation
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversation with messages
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationDetailResponse'
        '400':
          description: Invalid conversation ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from Better Auth

  schemas:
    # Request schemas
    SendMessageRequest:
      type: object
      required:
        - content
      properties:
        conversation_id:
          type: string
          format: uuid
          description: |
            UUID of existing conversation to continue.
            Omit to create new conversation.
          example: "123e4567-e89b-12d3-a456-426614174000"
        content:
          type: string
          minLength: 1
          maxLength: 32000
          description: Message text content
          example: "Hello, I need help organizing my tasks"

    # Response schemas
    SendMessageResponse:
      type: object
      required:
        - conversation_id
        - message
        - messages
      properties:
        conversation_id:
          type: string
          format: uuid
          description: UUID of the conversation
        message:
          $ref: '#/components/schemas/Message'
          description: The message that was just sent
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
          description: Full conversation history in chronological order

    ConversationListResponse:
      type: object
      required:
        - conversations
        - total
      properties:
        conversations:
          type: array
          items:
            $ref: '#/components/schemas/ConversationSummary'
        total:
          type: integer
          description: Total number of conversations for this user
          example: 15
        limit:
          type: integer
          description: Limit used for this request
          example: 20
        offset:
          type: integer
          description: Offset used for this request
          example: 0

    ConversationDetailResponse:
      type: object
      required:
        - conversation
        - messages
      properties:
        conversation:
          $ref: '#/components/schemas/Conversation'
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
          description: All messages in chronological order

    # Entity schemas
    Conversation:
      type: object
      required:
        - id
        - title
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        title:
          type: string
          maxLength: 255
          example: "Task management help"
        created_at:
          type: string
          format: date-time
          example: "2026-01-02T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-01-02T11:45:00Z"

    ConversationSummary:
      type: object
      required:
        - id
        - title
        - updated_at
        - message_count
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          maxLength: 255
        updated_at:
          type: string
          format: date-time
        message_count:
          type: integer
          description: Number of messages in conversation
          example: 12

    Message:
      type: object
      required:
        - id
        - role
        - content
        - created_at
      properties:
        id:
          type: string
          format: uuid
          example: "789e0123-e89b-12d3-a456-426614174000"
        role:
          type: string
          enum:
            - user
            - assistant
            - system
          example: "user"
        content:
          type: string
          maxLength: 32000
          example: "Please add a task to buy groceries"
        created_at:
          type: string
          format: date-time
          example: "2026-01-02T10:30:00Z"

    # Error schema
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              enum:
                - INVALID_ID_FORMAT
                - CONVERSATION_NOT_FOUND
                - ACCESS_DENIED
                - VALIDATION_ERROR
                - SERVICE_UNAVAILABLE
              example: "VALIDATION_ERROR"
            message:
              type: string
              example: "Message content cannot be empty"

security:
  - BearerAuth: []

tags:
  - name: Chat
    description: Send and receive chat messages
  - name: Conversations
    description: Manage conversation history
